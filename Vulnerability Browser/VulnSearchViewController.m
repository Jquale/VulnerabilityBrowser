//
//  VulnSearchViewController.m
//  Vulnerability Browser
//
//  Created by twslezak on 11/19/14.
//  Copyright (c) 2014 Quale, Slezak. All rights reserved.
//

#import "VulnSearchViewController.h"
#import <Parse/Parse.h>
#import "VulnerabilityObject.h"

@interface VulnSearchViewController ()
@property (weak, nonatomic) IBOutlet UITextField *searchTextField;

@property NSMutableArray* vulnerabilities;
@property NSString *theQuery;
@property NSMutableArray* yearArray;
@property NSArray* searchArray;


@end

@implementation VulnSearchViewController

- (void)viewDidLoad
{
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    //saving years
    self.yearArray = [[NSMutableArray alloc] init];
    for (int i = 0; i <= 11; i++)
    {
        NSNumber* year = [NSNumber numberWithInt:2003 + i ];
        [self.yearArray addObject:year];
    }
    
    self.vulnerabilities = [[NSMutableArray alloc] init];
    self.searchArray = [[NSArray alloc] init];
    
    [self getAllVulnerabilities];
    
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
    
    
    
}

/*
 #pragma mark - Navigation
 
 // In a storyboard-based application, you will often want to do a little preparation before navigation
 - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
 // Get the new view controller using [segue destinationViewController].
 // Pass the selected object to the new view controller.
 }
 */
//getting all of our vulnerabilities from parse
-(void)getAllVulnerabilities
{
    for (int i = 1; i<=11; i++) {
        //creating table name
        NSString *tableName = [[NSString alloc] initWithFormat: @"nvd%@", self.yearArray[i]];
        PFQuery *query = [PFQuery queryWithClassName:tableName];
        
        query.limit = 1000;
        
        [query findObjectsInBackgroundWithBlock:^(NSArray *objects, NSError *error) {
            if (!error) {
                // The find succeeded.
                //NSLog(@"Successfully retrieved %d queries.", objects.count);
                // Do something with the found objects
                for (PFObject *object in objects) {
                    //NSLog(@"%@", object.objectId);
                    
                    //creating the object
                    NSString *parseVulnName = object[@"name"];
                    NSString *parseVulnDate = object[@"date"];
                    NSString *parseVulnScore = object[@"score"];
                    NSString *parseVulnSummary = object[@"summary"];
                    
                    VulnerabilityObject *parseVulnerability = [[VulnerabilityObject alloc]initWithDataFromParse:parseVulnName
                                                                                                       vulnDate:parseVulnDate
                                                                                                      vulnScore:parseVulnScore
                                                                                                    vulnSummary:parseVulnSummary];
                    //adding the object to our array of vulnerabilities
                    [self.vulnerabilities addObject:parseVulnerability];
                    
                }
                
            }
            else
            {
                // Log details of the failure
                NSLog(@"Error: %@ %@", error, [error userInfo]);
            }
        }];
        
    }
}

//segue to pass the query
-(void) prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender
{
    //doing the logic to update my query based on what is selected
    
    NSPredicate *predicate = [NSPredicate predicateWithFormat:@"SELF.vulnSummary contains[c] %@",self.searchTextField.text];
    self.searchArray = [self.vulnerabilities filteredArrayUsingPredicate:predicate];
    //NSLog(@"HERE %@",self.searchArray);
    
    VulnerabilitySearchListViewController *dest = segue.destinationViewController;
    dest.vulnerabilityResults = self.searchArray;
    
}
@end
